# NestorWeb CGI scripts development guide

So you want to develop CGI scripts for NestorWeb? Great! You are in the right place.


## Hello, world!

```
;"Hello world" CGI script for NestorWeb

CR: equ 13
LF: equ 10
STDOUT: equ 1
_WRITE: equ 49h
_TERM:  equ 62h

    org 0100h

    ld de,HELLO
    ld hl,HELLO_END-HELLO
    ld b,STDOUT
    ld c,_WRITE
    call 0005h
    ld b,a  ;If can't write to STDOUT, terminate with error
    ld c,_TERM
    jp 0005h

HELLO:
    db "Content-Type: text/plain",CR,LF
    db "X-Custom-Header: Konamiman rocks",CR,LF
    db CR,LF
    db "Hello, world!"
HELLO_END:
```


## The basics

CGI is a mechanism for dynamically generating a HTTP response in response to a HTTP request. There's a RFC specifying it: [RFC 3875 - The Common Gateway Interface (CGI) Version 1.1](https://tools.ietf.org/html/rfc3875). In a nutshell: the request handling is delegated to an external program, which gets the full request and is responsible for generating the full response before terminating and transferring control back to the server process.

In the context of NestorWeb CGI scripts take the form of regular MSX-DOS executable programs as described in [MSX-DOS 2 Program Interface Specification](https://github.com/Konamiman/Nextor/blob/v2.1/docs/DOS2-PIS.TXT), that is:

* They are loaded and run at address 0100h.
* They get PROGRAM and PARAMETERS environment items properly set, and also [the command line](#command-line) at address 0080h.
* They can use whatever MSX-DOS function call they want via calls to 0005h.
* They can open, close and otherwise handle files however they need.
* They can allocate and free memory using the mapper support routines.
* They can terminate via RET with original stack pointer, via jump to address 0, via `_TERM0` function call and via `_TERM` function call (the later is the recommended way).

The only limitations of CGI scripts relative to a regular MSX-DOS program are:

* The maximum program size is 48K, instead of being the available TPA size.
* The **don't** receive the first two arguments converted to FCBs at addresses 0x005C and 0x006C.

NestorWeb imposes a few more restrictions for a file to be considered an executable CGI script:

* Support for CGI scripts must be enabled (it is by default).
* The script file must have `.CGI` or `.COM` extension.
* The script file must be located in a directory named `CGI-BIN` relative to the base directory (exactly in that directory, **not** in a subdirectory).
* Authentication mode must be 0 or 1, or if it's 2 proper credentials must have been supplied within the request.


## The script running process

When a valid request for running a CGI script is received by NestorWeb, the following happens:

1. The appropriate environment items holding the request headers and other relevant information about the request (according to [the CGI specification](https://tools.ietf.org/html/rfc3875)) are set.
2. A temporary file is created to contain the request body (it will be an empty file if the request verb is GET or HEAD). Using magic™ this file is made accessible via STDIN, that is, file handle 0.
3. A temporary file is created to hold the response headers and body. Using more magic™ this file is made accessible via STDOUT, that is, file handle 1.
4. The script file is loaded at address 0100h and executed. It reads the request from environment items and STDIN, writes the response to STDOUT, and terminates.
5. The NestorWeb executable file itself is reloaded from disk and executed (huge amounts of magic™ are used for this); it detects that it's returning from the execution of a script and restores its own state.
6. NestorWeb reads the temporary file with the response generated by the script, parses it and sends it to the client after appropriately converting it to a HTTP response.

The script program execution is enclosed in a pair of calls to `_FORK` and `_JOIN`, this means that it's safe for it to open/close files and to allocate mapped memory as needed; all of this will be cleared out as soon as NestorWeb is reloaded. But of course, weird things might happen if the script deletes the file it receives at STDOUT.

_Note:_ Of course, you can unveil all the magic™ by simply looking at the source code of NestorWeb.


## Environment items

The environment items for the request are appropriately set as per [the CGI specification](https://tools.ietf.org/html/rfc3875), but with the following limitations:

* `AUTH_TYPE` and `REMOTE_USER`: see [Authentication](#authentication) below.
* `REMOTE_IDENT` is never set.
* `SERVER_NAME` will contain the IP address of the computer running NestorWeb, instead of an actual name.

Additionally, NestorWeb creates the following environment items to be used by CGI scripts as appropriate:

* `_NWEB_TEMP`: contains the temporary directory used by NestorWeb, ending with `\`. This will be the value of the `NWEB_TEMP` environment item, the value of the `TEMP` environment item, or the location of the `NWEB.COM` file, in that order of precedence.
* `_NWEB_BASE_DIR`: contains the base directory used to serve static content, ending with `\`.
* `_NWEB_AUTH_MODE`: contains the current authentication mode as a single digit string (0, 1 or 2); see [Authentication](#authentication) below.


## Accessing the request and response files

The script program can access the request body via STDIN (file handle 0) and must write the response (headers and body) to STDOUT (file handle 1). Although the old MSX-DOS 1 function calls for console access could be used for that, it is strongly recommended to use the new MSX-DOS 2 file handle-based function calls (`_READ` and `_WRITE`) instead. First, because they are much more efficient; and second, because they allow to detect possible disk errors (see [Disk errors](#disk-errors) below).

Console access is still available via STDERR (file handle 2), however CGI scripts shouldn't access the console except for debugging purposes during development.


## Authentication

NestorWeb can be started with one of these authentication modes:

* 0: No authentication required (default).
* 1: Authentication required for serving static content and directory listings.
* 2: Authentication required for serving static content and directory listings, and also for running CGI scripts.

In modes 0 and 1 NestorWeb will run CGI scripts regardless of the presence or absence of authentication information (an `Authorization` header) in the request; in mode 2 authentication information must be present and must match the values of the `NWEB_USER` and `NWEB_PASSWORD` environment items. In all cases, if that information is present the following will happen before the script is executed:

* If the authentication scheme is anything but "Basic", then the `Authorization` header will be copied verbatim to an environment item named `HTTP_AUTHORIZATION`. No `AUTH_TYPE` or `REMOTE_USER` environment items will be set.
* If the authentication scheme is "Basic", then an `AUTH_TYPE` environment item with value "Basic" will be created. Additionally, the credentials will be Base64-decoded and put in `REMOTE_USER` and `REMOTE_PASSWORD` environment items (the later is a NestorWeb addition not defined in the CGI specification). This way the script doesn't need to implement Base64 decoding just to get the credentials.

Given the authentication information (or the lack of it), the script can decide whether to accept the request or return an error (typically via a `401 Unauthorized` or a `403 Forbidden` response - you can use [Predefined error responses](#predefined-error-responses) for this).

The value of the "realm" part in the `WWW-Authenticate` header that will be sent to the client when authentication is required but no credentials were supplied in the request will be taken from the `NWEB_REALM` environment item. The default value when this item is not present is "NestorWeb".


## Predefined error responses

If the script terminates using the `_TERM` function call it can provide a termination error code. NestorWeb will receive these codes and will interpret some of them as special values that will cause a predefined error response to be sent to the client; error codes for the most commonly used responses are defined as follows:

* 1: `400 Bad Request`
* 2: `404 Not Found`
* 3: `405 Method Not Allowed`
* 4: `304 Not Modified`
* 5: `401 Unauthorized` (also sends `WWW-Authenticate` header)
* 5: `403 Forbidden`

Any other non-zero error code will cause a `500 Internal Server Error` status to be sent to the client.

Additionally to this, if the script terminates with a zero error code and writes **nothing** to STDOUT, then a `204 No Content` status will be sent to the client.


## CGI response types

NestorWeb CGI scripts must generate the response by writing it to STDOUT and according to [the relevant part of the CGI specification](https://tools.ietf.org/html/rfc3875#section-6). There are however some restrictions:

* The `Status` header, if generated, must be the first one in the response.
* When generating a "Local Redirect" response, the `Location` header must be the first one in the response. This implies that this type of response can't be generated with a custom `Status` header.
* When generating a "Client Redirect" response, the `Location` header must be the first one in the response for NestorWeb to generate a proper `302 Found` header. If a different status is required, a `Status` header should be generated first, followed by the `Location` header.
* The "Client Redirect Response with Document" response type isn't supported.

On the other hand NestorWeb defines a new set of response types that can come in handy for scripts:


### Formatted error response

When NestorWeb returns an error response to clients it sends the proper status code and message according to the HTTP specification, but it also sends a (more or less) nicely HTML-formatted error page to be consumed by human users. CGI scripts can tell NestorWeb to send this error page with custom status code, status message and detailed message to the client by using the `X-CGI-Error` header as follows:

```
X-CGI-Error: <status code> <status message>
<blank line>
<detailed HTML-formatted message>
```

For example:

```
X-CGI-Error: 434 Bad Foobar

This <b>foobar</b> isn't <i>fizzbuzzed</i> enough.
```

Of course, the supplied status code and message will be used to generate the HTTP response status line.

The `X-CGI-Error` header **must** be followed by an empty line and then by the detailed error message, no additional headers are allowed.


### Non-parsed header response

The CGI specification [defines NPH scripts](https://tools.ietf.org/html/rfc3875#section-5) as scripts that take the responsibility of generating the full raw response, including the HTTP status line and all the headers including `Content-Length`. A NestorWeb CGI script is considered a NPH script if the first header it generates is `X-CGI-Response-Type: NPH`; everything past this header will be sent verbatim to the client without any further processing. For example:

```
X-CGI-Response-Type: NPH
HTTP/1.1 234 Ok, NPH style
Server: NestorWeb, but NPH-ed
Content-Type: text/plain
Content-Length: 3

MSX
```


### Content file response

CGI scripts can instruct NestorWeb to use the contents of a file for generating the response body by using the `X-CGI-Content-File` header as follows:

```
X-CGI-Content-File: <file path>
<additional headers>
<blank line>
```

`X-CGI-Content-File` must be the first generated header, but additional headers are allowed afterwards. Anything past the blank line will be ignored, since the full response body will be taken from the specified file.

The rules for `<file path>` are:

* It's relative to the location of the script program file (this means relative to `<base directory>\cgi-bin` in the current version of NestorWeb).
* It uses the MSX-DOS path separator, `\`.
* It does **not** start with `\`.

For example, if a file with path `<base directory>\cgi-bin\myscript\data.txt` exists containing the text `Hello!`, then the following response

```
X-CGI-Content-File: myscript\data.txt
Content-Type: text/plain
<blank line>
```

is equivalent to this one:

```
Content-Type: text/plain

Hello!
```

NestorWeb will use `Last-Modified`/`If-Modified-Since` semantics with this type of responses. This means that if a `If-Modified-Since` header is present in the request and the file hasn't been modified since the spceified date, then the response will not include the file contents and a `304 Not Modified` response will be sent instead; otherwise, a `Last-Modified` header will be appended to the generated response. All of this provided that the file has a valid last modification date.


## Command line

NestorWeb supports the script command line [as defined in the CGI specification](https://tools.ietf.org/html/rfc3875#section-4.4): scripts will receive the [urldecoded](https://en.wikipedia.org/wiki/Percent-encoding) request query string in the command line if the said query string doesn't contain any unencoded `=` character. For example, if the request has a query string of `?foo+bar+fizz%3Bbuzz` then the script will receive `foo bar fizz;buzz` as command line.

Keep in mind that such command line will only be generated if the query string has a length of 126 characters or less, since this is the maximum command line length supported by MSX-DOS.


## Disk errors

CGI scripts are run with a combination of disk error and abort handling routines (defined with function calls `_DEFAB` and `_DEFER`) that will cause any disk error to return an error code to the caller, instead of displaying the _"Abort, Retry, Ignore?"_ prompt in the console (which would be pretty weird for a server). Scripts should **not** redefine these routines, but if they do, they must do so in a way that user input is never required (something that, again, would be pretty weird for a server).


## Example scripts

The [CGI-BIN](cgi-bin) directory contains the source code of a few example CGI scripts. You might want to take a look to see actual examples of the concepts explained in this document.
